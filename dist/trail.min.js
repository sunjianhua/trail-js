(function(){"use strict";var t=this,e=e||{};e.sayHi=function(){console.log("%c trail.js* init \n","background: #ff1234; color: #ffffff")},e.Edge=function(t,n,r){var o=e.generateHash(t.x)+e.generateHash(t.y),i=e.generateHash(n.x)+e.generateHash(n.y),s=o+i;this.vertex1=t,this.vertex2=n,this.polygon=r,this.hash=s},e.Edge.prototype.getHash=function(){return this.hash},e.Edge.prototype.constructor=e.Edge,e.Mesh=function(){this.polygons=[],this.polygonLinks=[],this.graph=null},e.Mesh.prototype.getPolygons=function(){return this.polygons},e.Mesh.prototype.getPolygon=function(t){return this.polygons[t]},e.Mesh.prototype.addPolygon=function(t){this.polygons.push(t)},e.Mesh.prototype.prepareGraph=function(){this.edges=[],this.graph=[],this.polygonLinks=[];for(var t=0;t<this.polygons.length;t++)for(var n=this.polygons[t],r=n.getEdges(),o=0;o<r.length;o++){var i=r[o],s=i.getHash();void 0==this.polygonLinks[s]?this.polygonLinks[s]=[i]:this.polygonLinks[s].push(i)}for(var t=0;t<this.polygons.length;t++){var n=this.polygons[t],h=n.getCentroid(),a=new e.GraphNode(h.x,h.y);this.graph.push(a)}this.graph[0].connectedGraphNodes[0]=this.graph[1],console.log("created: "+this.graph.length+" graphnodes");for(var t=0;t<this.graph.length;t++){var a=this.graph[t];console.log("graphnode "+t+" has "+a.connectedGraphNodes.length+" connections")}},e.Mesh.prototype.constructor=e.Mesh,e.Polygon=function(t){this.setVertices(t)},e.Polygon.prototype.setVertices=function(t){this.vertices=[],this.edges=[];for(var n=0;n<t.length;n+=2){var r=new e.Vertex(t[n],t[n+1]);this.vertices.push(r)}for(var n=0;n<this.vertices.length;n++){var o;o=n<this.vertices.length-1?new e.Edge(this.vertices[n],this.vertices[n+1],this):new e.Edge(this.vertices[n],this.vertices[0],this),this.edges.push(o)}},e.Polygon.prototype.getVertices=function(){return this.vertices},e.Polygon.prototype.getVertex=function(t){return this.vertices[t]},e.Polygon.prototype.getEdges=function(){return this.edges},e.Polygon.prototype.setVertex=function(t,e){this.vertices[t]=e},e.Polygon.prototype.getCentroid=function(){for(var t,n,r,o=0,i=0,s=0,h=0,a=this.vertices.length-1;h<this.vertices.length;a=h++)t=this.vertices[h],n=this.vertices[a],r=t.x*n.y-n.x*t.y,o+=r,i+=(t.x+n.x)*r,s+=(t.y+n.y)*r;return r=3*o,new e.Vertex(i/r,s/r)},e.Polygon.prototype.constructor=e.Polygon,e.Vertex=function(t,e){this.x=t,this.y=e},e.Vertex.prototype.constructor=e.Vertex;var n={};n.IsSimple=function(t){var e=t.length>>1;if(4>e)return!0;for(var r=new n._P,o=new n._P,i=new n._P,s=new n._P,h=new n._P,a=0;e>a;a++){r.x=t[2*a],r.y=t[2*a+1],a==e-1?(o.x=t[0],o.y=t[1]):(o.x=t[2*a+2],o.y=t[2*a+3]);for(var y=0;e>y;y++)if(!(Math.abs(a-y)<2||y==e-1&&0==a||a==e-1&&0==y||(i.x=t[2*y],i.y=t[2*y+1],y==e-1?(s.x=t[0],s.y=t[1]):(s.x=t[2*y+2],s.y=t[2*y+3]),null==n._GetLineIntersection(r,o,i,s,h))))return!1}return!0},n.IsConvex=function(t){if(t.length<6)return!0;for(var e=t.length-4,r=0;e>r;r+=2)if(!n._convex(t[r],t[r+1],t[r+2],t[r+3],t[r+4],t[r+5]))return!1;return n._convex(t[e],t[e+1],t[e+2],t[e+3],t[0],t[1])?n._convex(t[e+2],t[e+3],t[0],t[1],t[2],t[3])?!0:!1:!1},n.GetArea=function(t){if(t.length<6)return 0;for(var e=t.length-2,n=0,r=0;e>r;r+=2)n+=(t[r+2]-t[r])*(t[r+1]+t[r+3]);return n+=(t[0]-t[e])*(t[e+1]+t[1]),.5*-n},n.GetAABB=function(t){for(var e=1/0,n=1/0,r=-e,o=-n,i=0;i<t.length;i+=2)e=Math.min(e,t[i]),r=Math.max(r,t[i]),n=Math.min(n,t[i+1]),o=Math.max(o,t[i+1]);return{x:e,y:n,width:r-e,height:o-n}},n.Reverse=function(t){for(var e=[],n=t.length-2;n>=0;n-=2)e.push(t[n],t[n+1]);return e},n.Triangulate=function(t){var e=t.length>>1;if(3>e)return[];for(var r=[],o=[],i=0;e>i;i++)o.push(i);for(var i=0,s=e;s>3;){var h=o[(i+0)%s],a=o[(i+1)%s],y=o[(i+2)%s],u=t[2*h],f=t[2*h+1],g=t[2*a],l=t[2*a+1],p=t[2*y],c=t[2*y+1],x=!1;if(n._convex(u,f,g,l,p,c)){x=!0;for(var v=0;s>v;v++){var d=o[v];if(d!=h&&d!=a&&d!=y&&n._PointInTriangle(t[2*d],t[2*d+1],u,f,g,l,p,c)){x=!1;break}}}if(x)r.push(h,a,y),o.splice((i+1)%s,1),s--,i=0;else if(i++>3*s)break}return r.push(o[0],o[1],o[2]),r},n.ContainsPoint=function(t,e,n){for(var r,o=t.length>>1,i=t[2*o-3]-n,s=t[2*o-2]-e,h=t[2*o-1]-n,a=0;o>a;a++)r=s,i=h,s=t[2*a]-e,h=t[2*a+1]-n,i!=h&&(lup=h>i);for(var y=0,a=0;o>a;a++)if(r=s,i=h,s=t[2*a]-e,h=t[2*a+1]-n,!(0>i&&0>h||i>0&&h>0||0>r&&0>s)){if(i==h&&Math.min(r,s)<=0)return!0;if(i!=h){var u=r+(s-r)*-i/(h-i);if(0==u)return!0;u>0&&y++,0==i&&lup&&h>i&&y--,0==i&&!lup&&i>h&&y--,lup=h>i}}return 1==(1&y)},n.Slice=function(t,e,r,o,i){if(n.ContainsPoint(t,e,r)||n.ContainsPoint(t,o,i))return[t.slice(0)];for(var s=new n._P(e,r),h=new n._P(o,i),a=[],y=[],u=0;u<t.length;u+=2)y.push(new n._P(t[u],t[u+1]));for(var u=0;u<y.length;u++){var f=new n._P(0,0);f=n._GetLineIntersection(s,h,y[u],y[(u+1)%y.length],f),f&&(f.flag=!0,a.push(f),y.splice(u+1,0,f),u++)}if(0==a.length)return[t.slice(0)];var g=function(t,e){return n._P.dist(s,t)-n._P.dist(s,e)};a.sort(g);for(var l=[],p=0;a.length>0;){var c=(y.length,a[0]),x=a[1],v=y.indexOf(c),d=y.indexOf(x),_=!1;if(n._firstWithFlag(y,v)==d?_=!0:(c=a[1],x=a[0],v=y.indexOf(c),d=y.indexOf(x),n._firstWithFlag(y,v)==d&&(_=!0)),_){p--;var P=n._getPoints(y,v,d);l.push(P),y=n._getPoints(y,d,v),c.flag=x.flag=!1,a.splice(0,2),0==a.length&&l.push(y)}else p++,a.reverse();if(p>1)break}for(var m=[],u=0;u<l.length;u++){for(var M=l[u],I=[],w=0;w<M.length;w++)I.push(M[w].x,M[w].y);m.push(I)}return m},n.Raycast=function(t,e,r,o,i,s){var h=t.length-2,a=n._tp,y=a[0],u=a[1],f=a[2],g=a[3],l=a[4];y.x=e,y.y=r,u.x=e+o,u.y=r+i,null==s&&(s={dist:0,edge:0,norm:{x:0,y:0},refl:{x:0,y:0}}),s.dist=1/0;for(var p=0;h>p;p+=2){f.x=t[p],f.y=t[p+1],g.x=t[p+2],g.y=t[p+3];var c=n._RayLineIntersection(y,u,f,g,l);c&&n._updateISC(o,i,y,f,g,l,p/2,s)}f.x=g.x,f.y=g.y,g.x=t[0],g.y=t[1];var c=n._RayLineIntersection(y,u,f,g,l);return c&&n._updateISC(o,i,y,f,g,l,t.length/2,s),1/0!=s.dist?s:null},n.ClosestEdge=function(t,e,r,o){{var i=t.length-2,s=n._tp,h=s[0],a=s[2],y=s[3];s[4]}h.x=e,h.y=r,null==o&&(o={dist:0,edge:0,point:{x:0,y:0},norm:{x:0,y:0}}),o.dist=1/0;for(var u=0;i>u;u+=2)a.x=t[u],a.y=t[u+1],y.x=t[u+2],y.y=t[u+3],n._pointLineDist(h,a,y,u>>1,o);a.x=y.x,a.y=y.y,y.x=t[0],y.y=t[1],n._pointLineDist(h,a,y,i>>1,o);var f=1/o.dist;return o.norm.x=(e-o.point.x)*f,o.norm.y=(r-o.point.y)*f,o},n._pointLineDist=function(t,e,n,r,o){var i,s,h=t.x,a=t.y,y=e.x,u=e.y,f=n.x,g=n.y,l=h-y,p=a-u,c=f-y,x=g-u,v=l*c+p*x,d=c*c+x*x,_=v/d;0>_||y==f&&u==g?(i=y,s=u):_>1?(i=f,s=g):(i=y+_*c,s=u+_*x);var P=h-i,m=a-s,M=Math.sqrt(P*P+m*m);M<o.dist&&(o.dist=M,o.edge=r,o.point.x=i,o.point.y=s)},n._updateISC=function(t,e,r,o,i,s,h,a){var y=n._P.dist(r,s);if(y<a.dist){var u=1/n._P.dist(o,i),f=-(i.y-o.y)*u,g=(i.x-o.x)*u,l=2*(t*f+e*g);a.dist=y,a.norm.x=f,a.norm.y=g,a.refl.x=-l*f+t,a.refl.y=-l*g+e,a.edge=h}},n._getPoints=function(t,e,n){var r=t.length,o=[];e>n&&(n+=r);for(var i=e;n>=i;i++)o.push(t[i%r]);return o},n._firstWithFlag=function(t,e){for(var n=t.length;;)if(e=(e+1)%n,t[e].flag)return e},n._PointInTriangle=function(t,e,n,r,o,i,s,h){var a=s-n,y=h-r,u=o-n,f=i-r,g=t-n,l=e-r,p=a*a+y*y,c=a*u+y*f,x=a*g+y*l,v=u*u+f*f,d=u*g+f*l,_=1/(p*v-c*c),P=(v*x-c*d)*_,m=(p*d-c*x)*_;return P>=0&&m>=0&&1>P+m},n._RayLineIntersection=function(t,e,r,o,i){var s=t.x-e.x,h=r.x-o.x,a=t.y-e.y,y=r.y-o.y,u=s*y-a*h;if(0==u)return null;var f=t.x*e.y-t.y*e.x,g=r.x*o.y-r.y*o.x,l=i,p=1/u;return l.x=(f*h-s*g)*p,l.y=(f*y-a*g)*p,n._InRect(l,r,o)?a>0&&l.y>t.y||0>a&&l.y<t.y?null:s>0&&l.x>t.x||0>s&&l.x<t.x?null:l:null},n._GetLineIntersection=function(t,e,r,o,i){var s=t.x-e.x,h=r.x-o.x,a=t.y-e.y,y=r.y-o.y,u=s*y-a*h;if(0==u)return null;var f=t.x*e.y-t.y*e.x,g=r.x*o.y-r.y*o.x,l=i;return l.x=(f*h-s*g)/u,l.y=(f*y-a*g)/u,n._InRect(l,t,e)&&n._InRect(l,r,o)?l:null},n._InRect=function(t,e,n){return e.x==n.x?t.y>=Math.min(e.y,n.y)&&t.y<=Math.max(e.y,n.y):e.y==n.y?t.x>=Math.min(e.x,n.x)&&t.x<=Math.max(e.x,n.x):t.x>=Math.min(e.x,n.x)&&t.x<=Math.max(e.x,n.x)&&t.y>=Math.min(e.y,n.y)&&t.y<=Math.max(e.y,n.y)?!0:!1},n._convex=function(t,e,n,r,o,i){return(e-r)*(o-n)+(n-t)*(i-r)>=0},n._P=function(t,e){this.x=t,this.y=e,this.flag=!1},n._P.prototype.toString=function(){return"Point ["+this.x+", "+this.y+"]"},n._P.dist=function(t,e){var n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)},n._tp=[];for(var r=0;10>r;r++)n._tp.push(new n._P(0,0));e.Graph=function(){},e.Graph.prototype.constructor=e.Graph,e.GraphNode=function(t,e){this.x=t,this.y=e,this.connectedGraphNodes=[]},e.GraphNode.prototype.constructor=e.GraphNode,e.verticesFromPolygon=function(t){for(var e=t.getVertices(),n=[],r=0;r<e.length;r++){var o=e[r];n.push(o.x,o.y)}return n},e.trianglesFromVertexArray=function(t){for(var n=[],r=0;r<t.length/6;r+=6){new e.Polygon([r,r+1,r+2,r+3,r+4,r+5])}return n},e.generateHash=function(t){return t=61^t^t>>16,t+=t<<3,t^=t>>4,t*=668265261,t^=t>>15},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=e),exports.TRAIL=e):"undefined"!=typeof define&&define.amd?define(e):t.TRAIL=e}).call(this);