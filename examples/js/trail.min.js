(function(){"use strict";var t=this,e=e||{};e.sayHi=function(){console.log("%c trail.js* init \n","background: #ff1234; color: #ffffff")},e.Mesh=function(){this.polygons=[],this.polygonLinks=[],this.graph=null},e.Mesh.prototype.getPolygons=function(){return this.polygons},e.Mesh.prototype.getPolygon=function(t){return this.polygons[t]},e.Mesh.prototype.addPolygon=function(t){this.polygons.push(t)},e.Mesh.prototype.prepareGraph=function(){this.edges=[],this.graph=[];for(var t=0;t<this.polygons.length;t++)for(var n=this.polygons[t],r=n.getCentroid(),i=(new e.GraphNode(r.x,r.y),n.getEdges()),o=0;o<i.length;o++){var s=i[o];void 0==this.polygonLinks[s]?this.polygonLinks[s]=[n]:this.polygonLinks[s].push(n)}},e.Mesh.prototype.constructor=e.Mesh,e.Polygon=function(t){this.setVertices(t)},e.Polygon.prototype.setVertices=function(t){this.vertices=[],this.edges=[];for(var n=0;n<t.length;n+=2){var r=new e.Vertex(t[n],t[n+1]);this.vertices.push(r)}for(var n=0;n<this.vertices.length;n++){var i,o,s;n<this.vertices.length-1?(i=e.generateHash(this.vertices[n].x)+e.generateHash(this.vertices[n].y),o=e.generateHash(this.vertices[n+1].x)+e.generateHash(this.vertices[n+1].y),s=i+o):(i=e.generateHash(this.vertices[n].x)+e.generateHash(this.vertices[n].y),o=e.generateHash(this.vertices[0].x)+e.generateHash(this.vertices[0].y),s=i+o),this.edges.push(s)}},e.Polygon.prototype.getVertices=function(){return this.vertices},e.Polygon.prototype.getVertex=function(t){return this.vertices[t]},e.Polygon.prototype.getEdges=function(){return this.edges},e.Polygon.prototype.setVertex=function(t,e){this.vertices[t]=e},e.Polygon.prototype.getCentroid=function(){for(var t,n,r,i=0,o=0,s=0,a=0,h=this.vertices.length-1;a<this.vertices.length;h=a++)t=this.vertices[a],n=this.vertices[h],r=t.x*n.y-n.x*t.y,i+=r,o+=(t.x+n.x)*r,s+=(t.y+n.y)*r;return r=3*i,new e.Vertex(o/r,s/r)},e.Polygon.prototype.constructor=e.Polygon,e.Vertex=function(t,e){this.x=t,this.y=e},e.Vertex.prototype.constructor=e.Vertex;var n={};n.IsSimple=function(t){var e=t.length>>1;if(4>e)return!0;for(var r=new n._P,i=new n._P,o=new n._P,s=new n._P,a=new n._P,h=0;e>h;h++){r.x=t[2*h],r.y=t[2*h+1],h==e-1?(i.x=t[0],i.y=t[1]):(i.x=t[2*h+2],i.y=t[2*h+3]);for(var y=0;e>y;y++)if(!(Math.abs(h-y)<2||y==e-1&&0==h||h==e-1&&0==y||(o.x=t[2*y],o.y=t[2*y+1],y==e-1?(s.x=t[0],s.y=t[1]):(s.x=t[2*y+2],s.y=t[2*y+3]),null==n._GetLineIntersection(r,i,o,s,a))))return!1}return!0},n.IsConvex=function(t){if(t.length<6)return!0;for(var e=t.length-4,r=0;e>r;r+=2)if(!n._convex(t[r],t[r+1],t[r+2],t[r+3],t[r+4],t[r+5]))return!1;return n._convex(t[e],t[e+1],t[e+2],t[e+3],t[0],t[1])?n._convex(t[e+2],t[e+3],t[0],t[1],t[2],t[3])?!0:!1:!1},n.GetArea=function(t){if(t.length<6)return 0;for(var e=t.length-2,n=0,r=0;e>r;r+=2)n+=(t[r+2]-t[r])*(t[r+1]+t[r+3]);return n+=(t[0]-t[e])*(t[e+1]+t[1]),.5*-n},n.GetAABB=function(t){for(var e=1/0,n=1/0,r=-e,i=-n,o=0;o<t.length;o+=2)e=Math.min(e,t[o]),r=Math.max(r,t[o]),n=Math.min(n,t[o+1]),i=Math.max(i,t[o+1]);return{x:e,y:n,width:r-e,height:i-n}},n.Reverse=function(t){for(var e=[],n=t.length-2;n>=0;n-=2)e.push(t[n],t[n+1]);return e},n.Triangulate=function(t){var e=t.length>>1;if(3>e)return[];for(var r=[],i=[],o=0;e>o;o++)i.push(o);for(var o=0,s=e;s>3;){var a=i[(o+0)%s],h=i[(o+1)%s],y=i[(o+2)%s],u=t[2*a],f=t[2*a+1],l=t[2*h],x=t[2*h+1],c=t[2*y],g=t[2*y+1],p=!1;if(n._convex(u,f,l,x,c,g)){p=!0;for(var v=0;s>v;v++){var d=i[v];if(d!=a&&d!=h&&d!=y&&n._PointInTriangle(t[2*d],t[2*d+1],u,f,l,x,c,g)){p=!1;break}}}if(p)r.push(a,h,y),i.splice((o+1)%s,1),s--,o=0;else if(o++>3*s)break}return r.push(i[0],i[1],i[2]),r},n.ContainsPoint=function(t,e,n){for(var r,i=t.length>>1,o=t[2*i-3]-n,s=t[2*i-2]-e,a=t[2*i-1]-n,h=0;i>h;h++)r=s,o=a,s=t[2*h]-e,a=t[2*h+1]-n,o!=a&&(lup=a>o);for(var y=0,h=0;i>h;h++)if(r=s,o=a,s=t[2*h]-e,a=t[2*h+1]-n,!(0>o&&0>a||o>0&&a>0||0>r&&0>s)){if(o==a&&Math.min(r,s)<=0)return!0;if(o!=a){var u=r+(s-r)*-o/(a-o);if(0==u)return!0;u>0&&y++,0==o&&lup&&a>o&&y--,0==o&&!lup&&o>a&&y--,lup=a>o}}return 1==(1&y)},n.Slice=function(t,e,r,i,o){if(n.ContainsPoint(t,e,r)||n.ContainsPoint(t,i,o))return[t.slice(0)];for(var s=new n._P(e,r),a=new n._P(i,o),h=[],y=[],u=0;u<t.length;u+=2)y.push(new n._P(t[u],t[u+1]));for(var u=0;u<y.length;u++){var f=new n._P(0,0);f=n._GetLineIntersection(s,a,y[u],y[(u+1)%y.length],f),f&&(f.flag=!0,h.push(f),y.splice(u+1,0,f),u++)}if(0==h.length)return[t.slice(0)];var l=function(t,e){return n._P.dist(s,t)-n._P.dist(s,e)};h.sort(l);for(var x=[],c=0;h.length>0;){var g=(y.length,h[0]),p=h[1],v=y.indexOf(g),d=y.indexOf(p),_=!1;if(n._firstWithFlag(y,v)==d?_=!0:(g=h[1],p=h[0],v=y.indexOf(g),d=y.indexOf(p),n._firstWithFlag(y,v)==d&&(_=!0)),_){c--;var P=n._getPoints(y,v,d);x.push(P),y=n._getPoints(y,d,v),g.flag=p.flag=!1,h.splice(0,2),0==h.length&&x.push(y)}else c++,h.reverse();if(c>1)break}for(var m=[],u=0;u<x.length;u++){for(var M=x[u],I=[],w=0;w<M.length;w++)I.push(M[w].x,M[w].y);m.push(I)}return m},n.Raycast=function(t,e,r,i,o,s){var a=t.length-2,h=n._tp,y=h[0],u=h[1],f=h[2],l=h[3],x=h[4];y.x=e,y.y=r,u.x=e+i,u.y=r+o,null==s&&(s={dist:0,edge:0,norm:{x:0,y:0},refl:{x:0,y:0}}),s.dist=1/0;for(var c=0;a>c;c+=2){f.x=t[c],f.y=t[c+1],l.x=t[c+2],l.y=t[c+3];var g=n._RayLineIntersection(y,u,f,l,x);g&&n._updateISC(i,o,y,f,l,x,c/2,s)}f.x=l.x,f.y=l.y,l.x=t[0],l.y=t[1];var g=n._RayLineIntersection(y,u,f,l,x);return g&&n._updateISC(i,o,y,f,l,x,t.length/2,s),1/0!=s.dist?s:null},n.ClosestEdge=function(t,e,r,i){{var o=t.length-2,s=n._tp,a=s[0],h=s[2],y=s[3];s[4]}a.x=e,a.y=r,null==i&&(i={dist:0,edge:0,point:{x:0,y:0},norm:{x:0,y:0}}),i.dist=1/0;for(var u=0;o>u;u+=2)h.x=t[u],h.y=t[u+1],y.x=t[u+2],y.y=t[u+3],n._pointLineDist(a,h,y,u>>1,i);h.x=y.x,h.y=y.y,y.x=t[0],y.y=t[1],n._pointLineDist(a,h,y,o>>1,i);var f=1/i.dist;return i.norm.x=(e-i.point.x)*f,i.norm.y=(r-i.point.y)*f,i},n._pointLineDist=function(t,e,n,r,i){var o,s,a=t.x,h=t.y,y=e.x,u=e.y,f=n.x,l=n.y,x=a-y,c=h-u,g=f-y,p=l-u,v=x*g+c*p,d=g*g+p*p,_=v/d;0>_||y==f&&u==l?(o=y,s=u):_>1?(o=f,s=l):(o=y+_*g,s=u+_*p);var P=a-o,m=h-s,M=Math.sqrt(P*P+m*m);M<i.dist&&(i.dist=M,i.edge=r,i.point.x=o,i.point.y=s)},n._updateISC=function(t,e,r,i,o,s,a,h){var y=n._P.dist(r,s);if(y<h.dist){var u=1/n._P.dist(i,o),f=-(o.y-i.y)*u,l=(o.x-i.x)*u,x=2*(t*f+e*l);h.dist=y,h.norm.x=f,h.norm.y=l,h.refl.x=-x*f+t,h.refl.y=-x*l+e,h.edge=a}},n._getPoints=function(t,e,n){var r=t.length,i=[];e>n&&(n+=r);for(var o=e;n>=o;o++)i.push(t[o%r]);return i},n._firstWithFlag=function(t,e){for(var n=t.length;;)if(e=(e+1)%n,t[e].flag)return e},n._PointInTriangle=function(t,e,n,r,i,o,s,a){var h=s-n,y=a-r,u=i-n,f=o-r,l=t-n,x=e-r,c=h*h+y*y,g=h*u+y*f,p=h*l+y*x,v=u*u+f*f,d=u*l+f*x,_=1/(c*v-g*g),P=(v*p-g*d)*_,m=(c*d-g*p)*_;return P>=0&&m>=0&&1>P+m},n._RayLineIntersection=function(t,e,r,i,o){var s=t.x-e.x,a=r.x-i.x,h=t.y-e.y,y=r.y-i.y,u=s*y-h*a;if(0==u)return null;var f=t.x*e.y-t.y*e.x,l=r.x*i.y-r.y*i.x,x=o,c=1/u;return x.x=(f*a-s*l)*c,x.y=(f*y-h*l)*c,n._InRect(x,r,i)?h>0&&x.y>t.y||0>h&&x.y<t.y?null:s>0&&x.x>t.x||0>s&&x.x<t.x?null:x:null},n._GetLineIntersection=function(t,e,r,i,o){var s=t.x-e.x,a=r.x-i.x,h=t.y-e.y,y=r.y-i.y,u=s*y-h*a;if(0==u)return null;var f=t.x*e.y-t.y*e.x,l=r.x*i.y-r.y*i.x,x=o;return x.x=(f*a-s*l)/u,x.y=(f*y-h*l)/u,n._InRect(x,t,e)&&n._InRect(x,r,i)?x:null},n._InRect=function(t,e,n){return e.x==n.x?t.y>=Math.min(e.y,n.y)&&t.y<=Math.max(e.y,n.y):e.y==n.y?t.x>=Math.min(e.x,n.x)&&t.x<=Math.max(e.x,n.x):t.x>=Math.min(e.x,n.x)&&t.x<=Math.max(e.x,n.x)&&t.y>=Math.min(e.y,n.y)&&t.y<=Math.max(e.y,n.y)?!0:!1},n._convex=function(t,e,n,r,i,o){return(e-r)*(i-n)+(n-t)*(o-r)>=0},n._P=function(t,e){this.x=t,this.y=e,this.flag=!1},n._P.prototype.toString=function(){return"Point ["+this.x+", "+this.y+"]"},n._P.dist=function(t,e){var n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)},n._tp=[];for(var r=0;10>r;r++)n._tp.push(new n._P(0,0));e.Graph=function(){},e.Graph.prototype.constructor=e.Graph,e.GraphNode=function(t,e){this.x=t,this.y=e,this.connectedGraphNodes=[]},e.GraphNode.prototype.constructor=e.GraphNode,e.verticesFromPolygon=function(t){for(var e=t.getVertices(),n=[],r=0;r<e.length;r++){var i=e[r];n.push(i.x,i.y)}return n},e.trianglesFromVertexArray=function(t){for(var n=[],r=0;r<t.length/6;r+=6){new e.Polygon([r,r+1,r+2,r+3,r+4,r+5])}return n},e.generateHash=function(t){return t=61^t^t>>16,t+=t<<3,t^=t>>4,t*=668265261,t^=t>>15},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=e),exports.TRAIL=e):"undefined"!=typeof define&&define.amd?define(e):t.TRAIL=e}).call(this);