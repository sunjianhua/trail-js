(function(){"use strict";var t=this,e=e||{};e.sayHi=function(){console.log("%c trail.js* init \n","background: #ff1234; color: #ffffff")},e.Mesh=function(){this.polygons=[],this.polygonLinks=[]},e.Mesh.prototype.getPolygons=function(){return this.polygons},e.Mesh.prototype.getPolygon=function(t){return this.polygons[t]},e.Mesh.prototype.addPolygon=function(t){this.polygons.push(t)},e.Mesh.prototype.calculatePolygonLinks=function(){for(var t=0;t<this.polygons.length;t++)for(var e=this.polygons[t],n=e.getEdges(),r=0;r<n.length;r++){var i=n[r];void 0==this.polygonLinks[i]?this.polygonLinks[i]=[e]:this.polygonLinks[i].push(e)}console.log("graph test*"),console.dir(this.polygonLinks)},e.Mesh.prototype.constructor=e.Mesh,e.Polygon=function(t){this.setVertices(t)},e.Polygon.prototype.setVertices=function(t){this.vertices=[],this.edges=[];for(var n=0;n<t.length;n+=2){var r=new e.Vertex(t[n],t[n+1]);this.vertices.push(r)}for(var n=0;n<this.vertices.length;n++){var i,o,s;n<this.vertices.length-1?(i=e.generateHash(this.vertices[n].x)+e.generateHash(this.vertices[n].y),o=e.generateHash(this.vertices[n+1].x)+e.generateHash(this.vertices[n+1].y),s=i+o):(i=e.generateHash(this.vertices[n].x)+e.generateHash(this.vertices[n].y),o=e.generateHash(this.vertices[0].x)+e.generateHash(this.vertices[0].y),s=i+o),this.edges.push(s)}console.log(this.edges)},e.Polygon.prototype.getVertices=function(){return this.vertices},e.Polygon.prototype.getVertex=function(t){return this.vertices[t]},e.Polygon.prototype.getEdges=function(){return this.edges},e.Polygon.prototype.setVertex=function(t,e){this.vertices[t]=e},e.Polygon.prototype.constructor=e.Polygon,e.Vertex=function(t,e){this.x=t,this.y=e},e.Vertex.prototype.constructor=e.Vertex;var n={};n.IsSimple=function(t){var e=t.length>>1;if(4>e)return!0;for(var r=new n._P,i=new n._P,o=new n._P,s=new n._P,a=new n._P,y=0;e>y;y++){r.x=t[2*y],r.y=t[2*y+1],y==e-1?(i.x=t[0],i.y=t[1]):(i.x=t[2*y+2],i.y=t[2*y+3]);for(var u=0;e>u;u++)if(!(Math.abs(y-u)<2||u==e-1&&0==y||y==e-1&&0==u||(o.x=t[2*u],o.y=t[2*u+1],u==e-1?(s.x=t[0],s.y=t[1]):(s.x=t[2*u+2],s.y=t[2*u+3]),null==n._GetLineIntersection(r,i,o,s,a))))return!1}return!0},n.IsConvex=function(t){if(t.length<6)return!0;for(var e=t.length-4,r=0;e>r;r+=2)if(!n._convex(t[r],t[r+1],t[r+2],t[r+3],t[r+4],t[r+5]))return!1;return n._convex(t[e],t[e+1],t[e+2],t[e+3],t[0],t[1])?n._convex(t[e+2],t[e+3],t[0],t[1],t[2],t[3])?!0:!1:!1},n.GetArea=function(t){if(t.length<6)return 0;for(var e=t.length-2,n=0,r=0;e>r;r+=2)n+=(t[r+2]-t[r])*(t[r+1]+t[r+3]);return n+=(t[0]-t[e])*(t[e+1]+t[1]),.5*-n},n.GetAABB=function(t){for(var e=1/0,n=1/0,r=-e,i=-n,o=0;o<t.length;o+=2)e=Math.min(e,t[o]),r=Math.max(r,t[o]),n=Math.min(n,t[o+1]),i=Math.max(i,t[o+1]);return{x:e,y:n,width:r-e,height:i-n}},n.Reverse=function(t){for(var e=[],n=t.length-2;n>=0;n-=2)e.push(t[n],t[n+1]);return e},n.Triangulate=function(t){var e=t.length>>1;if(3>e)return[];for(var r=[],i=[],o=0;e>o;o++)i.push(o);for(var o=0,s=e;s>3;){var a=i[(o+0)%s],y=i[(o+1)%s],u=i[(o+2)%s],h=t[2*a],f=t[2*a+1],l=t[2*y],x=t[2*y+1],g=t[2*u],c=t[2*u+1],p=!1;if(n._convex(h,f,l,x,g,c)){p=!0;for(var v=0;s>v;v++){var d=i[v];if(d!=a&&d!=y&&d!=u&&n._PointInTriangle(t[2*d],t[2*d+1],h,f,l,x,g,c)){p=!1;break}}}if(p)r.push(a,y,u),i.splice((o+1)%s,1),s--,o=0;else if(o++>3*s)break}return r.push(i[0],i[1],i[2]),r},n.ContainsPoint=function(t,e,n){for(var r,i=t.length>>1,o=t[2*i-3]-n,s=t[2*i-2]-e,a=t[2*i-1]-n,y=0;i>y;y++)r=s,o=a,s=t[2*y]-e,a=t[2*y+1]-n,o!=a&&(lup=a>o);for(var u=0,y=0;i>y;y++)if(r=s,o=a,s=t[2*y]-e,a=t[2*y+1]-n,!(0>o&&0>a||o>0&&a>0||0>r&&0>s)){if(o==a&&Math.min(r,s)<=0)return!0;if(o!=a){var h=r+(s-r)*-o/(a-o);if(0==h)return!0;h>0&&u++,0==o&&lup&&a>o&&u--,0==o&&!lup&&o>a&&u--,lup=a>o}}return 1==(1&u)},n.Slice=function(t,e,r,i,o){if(n.ContainsPoint(t,e,r)||n.ContainsPoint(t,i,o))return[t.slice(0)];for(var s=new n._P(e,r),a=new n._P(i,o),y=[],u=[],h=0;h<t.length;h+=2)u.push(new n._P(t[h],t[h+1]));for(var h=0;h<u.length;h++){var f=new n._P(0,0);f=n._GetLineIntersection(s,a,u[h],u[(h+1)%u.length],f),f&&(f.flag=!0,y.push(f),u.splice(h+1,0,f),h++)}if(0==y.length)return[t.slice(0)];var l=function(t,e){return n._P.dist(s,t)-n._P.dist(s,e)};y.sort(l);for(var x=[],g=0;y.length>0;){var c=(u.length,y[0]),p=y[1],v=u.indexOf(c),d=u.indexOf(p),_=!1;if(n._firstWithFlag(u,v)==d?_=!0:(c=y[1],p=y[0],v=u.indexOf(c),d=u.indexOf(p),n._firstWithFlag(u,v)==d&&(_=!0)),_){g--;var P=n._getPoints(u,v,d);x.push(P),u=n._getPoints(u,d,v),c.flag=p.flag=!1,y.splice(0,2),0==y.length&&x.push(u)}else g++,y.reverse();if(g>1)break}for(var m=[],h=0;h<x.length;h++){for(var M=x[h],I=[],L=0;L<M.length;L++)I.push(M[L].x,M[L].y);m.push(I)}return m},n.Raycast=function(t,e,r,i,o,s){var a=t.length-2,y=n._tp,u=y[0],h=y[1],f=y[2],l=y[3],x=y[4];u.x=e,u.y=r,h.x=e+i,h.y=r+o,null==s&&(s={dist:0,edge:0,norm:{x:0,y:0},refl:{x:0,y:0}}),s.dist=1/0;for(var g=0;a>g;g+=2){f.x=t[g],f.y=t[g+1],l.x=t[g+2],l.y=t[g+3];var c=n._RayLineIntersection(u,h,f,l,x);c&&n._updateISC(i,o,u,f,l,x,g/2,s)}f.x=l.x,f.y=l.y,l.x=t[0],l.y=t[1];var c=n._RayLineIntersection(u,h,f,l,x);return c&&n._updateISC(i,o,u,f,l,x,t.length/2,s),1/0!=s.dist?s:null},n.ClosestEdge=function(t,e,r,i){{var o=t.length-2,s=n._tp,a=s[0],y=s[2],u=s[3];s[4]}a.x=e,a.y=r,null==i&&(i={dist:0,edge:0,point:{x:0,y:0},norm:{x:0,y:0}}),i.dist=1/0;for(var h=0;o>h;h+=2)y.x=t[h],y.y=t[h+1],u.x=t[h+2],u.y=t[h+3],n._pointLineDist(a,y,u,h>>1,i);y.x=u.x,y.y=u.y,u.x=t[0],u.y=t[1],n._pointLineDist(a,y,u,o>>1,i);var f=1/i.dist;return i.norm.x=(e-i.point.x)*f,i.norm.y=(r-i.point.y)*f,i},n._pointLineDist=function(t,e,n,r,i){var o,s,a=t.x,y=t.y,u=e.x,h=e.y,f=n.x,l=n.y,x=a-u,g=y-h,c=f-u,p=l-h,v=x*c+g*p,d=c*c+p*p,_=v/d;0>_||u==f&&h==l?(o=u,s=h):_>1?(o=f,s=l):(o=u+_*c,s=h+_*p);var P=a-o,m=y-s,M=Math.sqrt(P*P+m*m);M<i.dist&&(i.dist=M,i.edge=r,i.point.x=o,i.point.y=s)},n._updateISC=function(t,e,r,i,o,s,a,y){var u=n._P.dist(r,s);if(u<y.dist){var h=1/n._P.dist(i,o),f=-(o.y-i.y)*h,l=(o.x-i.x)*h,x=2*(t*f+e*l);y.dist=u,y.norm.x=f,y.norm.y=l,y.refl.x=-x*f+t,y.refl.y=-x*l+e,y.edge=a}},n._getPoints=function(t,e,n){var r=t.length,i=[];e>n&&(n+=r);for(var o=e;n>=o;o++)i.push(t[o%r]);return i},n._firstWithFlag=function(t,e){for(var n=t.length;;)if(e=(e+1)%n,t[e].flag)return e},n._PointInTriangle=function(t,e,n,r,i,o,s,a){var y=s-n,u=a-r,h=i-n,f=o-r,l=t-n,x=e-r,g=y*y+u*u,c=y*h+u*f,p=y*l+u*x,v=h*h+f*f,d=h*l+f*x,_=1/(g*v-c*c),P=(v*p-c*d)*_,m=(g*d-c*p)*_;return P>=0&&m>=0&&1>P+m},n._RayLineIntersection=function(t,e,r,i,o){var s=t.x-e.x,a=r.x-i.x,y=t.y-e.y,u=r.y-i.y,h=s*u-y*a;if(0==h)return null;var f=t.x*e.y-t.y*e.x,l=r.x*i.y-r.y*i.x,x=o,g=1/h;return x.x=(f*a-s*l)*g,x.y=(f*u-y*l)*g,n._InRect(x,r,i)?y>0&&x.y>t.y||0>y&&x.y<t.y?null:s>0&&x.x>t.x||0>s&&x.x<t.x?null:x:null},n._GetLineIntersection=function(t,e,r,i,o){var s=t.x-e.x,a=r.x-i.x,y=t.y-e.y,u=r.y-i.y,h=s*u-y*a;if(0==h)return null;var f=t.x*e.y-t.y*e.x,l=r.x*i.y-r.y*i.x,x=o;return x.x=(f*a-s*l)/h,x.y=(f*u-y*l)/h,n._InRect(x,t,e)&&n._InRect(x,r,i)?x:null},n._InRect=function(t,e,n){return e.x==n.x?t.y>=Math.min(e.y,n.y)&&t.y<=Math.max(e.y,n.y):e.y==n.y?t.x>=Math.min(e.x,n.x)&&t.x<=Math.max(e.x,n.x):t.x>=Math.min(e.x,n.x)&&t.x<=Math.max(e.x,n.x)&&t.y>=Math.min(e.y,n.y)&&t.y<=Math.max(e.y,n.y)?!0:!1},n._convex=function(t,e,n,r,i,o){return(e-r)*(i-n)+(n-t)*(o-r)>=0},n._P=function(t,e){this.x=t,this.y=e,this.flag=!1},n._P.prototype.toString=function(){return"Point ["+this.x+", "+this.y+"]"},n._P.dist=function(t,e){var n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)},n._tp=[];for(var r=0;10>r;r++)n._tp.push(new n._P(0,0));e.verticesFromPolygon=function(t){for(var e=t.getVertices(),n=[],r=0;r<e.length;r++){var i=e[r];n.push(i.x,i.y)}return n},e.trianglesFromVertexArray=function(t){for(var n=[],r=0;r<t.length/6;r+=6){new e.Polygon([r,r+1,r+2,r+3,r+4,r+5])}return n},e.generateHash=function(t){return t=61^t^t>>16,t+=t<<3,t^=t>>4,t*=668265261,t^=t>>15},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=e),exports.TRAIL=e):"undefined"!=typeof define&&define.amd?define(e):t.TRAIL=e}).call(this);