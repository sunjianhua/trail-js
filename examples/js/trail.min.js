(function(){"use strict";var t=this,n=n||{};n.sayHi=function(){console.log("%c trail.js* init \n","background: #ff1234; color: #ffffff")};var e={};e.IsSimple=function(t){var n=t.length>>1;if(4>n)return!0;for(var r=new e._P,o=new e._P,i=new e._P,s=new e._P,h=new e._P,y=0;n>y;y++){r.x=t[2*y],r.y=t[2*y+1],y==n-1?(o.x=t[0],o.y=t[1]):(o.x=t[2*y+2],o.y=t[2*y+3]);for(var a=0;n>a;a++)if(!(Math.abs(y-a)<2||a==n-1&&0==y||y==n-1&&0==a||(i.x=t[2*a],i.y=t[2*a+1],a==n-1?(s.x=t[0],s.y=t[1]):(s.x=t[2*a+2],s.y=t[2*a+3]),null==e._GetLineIntersection(r,o,i,s,h))))return!1}return!0},e.IsConvex=function(t){if(t.length<6)return!0;for(var n=t.length-4,r=0;n>r;r+=2)if(!e._convex(t[r],t[r+1],t[r+2],t[r+3],t[r+4],t[r+5]))return!1;return e._convex(t[n],t[n+1],t[n+2],t[n+3],t[0],t[1])?e._convex(t[n+2],t[n+3],t[0],t[1],t[2],t[3])?!0:!1:!1},e.GetArea=function(t){if(t.length<6)return 0;for(var n=t.length-2,e=0,r=0;n>r;r+=2)e+=(t[r+2]-t[r])*(t[r+1]+t[r+3]);return e+=(t[0]-t[n])*(t[n+1]+t[1]),.5*-e},e.GetAABB=function(t){for(var n=1/0,e=1/0,r=-n,o=-e,i=0;i<t.length;i+=2)n=Math.min(n,t[i]),r=Math.max(r,t[i]),e=Math.min(e,t[i+1]),o=Math.max(o,t[i+1]);return{x:n,y:e,width:r-n,height:o-e}},e.Reverse=function(t){for(var n=[],e=t.length-2;e>=0;e-=2)n.push(t[e],t[e+1]);return n},e.Triangulate=function(t){var n=t.length>>1;if(3>n)return[];for(var r=[],o=[],i=0;n>i;i++)o.push(i);for(var i=0,s=n;s>3;){var h=o[(i+0)%s],y=o[(i+1)%s],a=o[(i+2)%s],l=t[2*h],g=t[2*h+1],u=t[2*y],p=t[2*y+1],f=t[2*a],x=t[2*a+1],c=!1;if(e._convex(l,g,u,p,f,x)){c=!0;for(var v=0;s>v;v++){var d=o[v];if(d!=h&&d!=y&&d!=a&&e._PointInTriangle(t[2*d],t[2*d+1],l,g,u,p,f,x)){c=!1;break}}}if(c)r.push(h,y,a),o.splice((i+1)%s,1),s--,i=0;else if(i++>3*s)break}return r.push(o[0],o[1],o[2]),r},e.ContainsPoint=function(t,n,e){for(var r,o=t.length>>1,i=t[2*o-3]-e,s=t[2*o-2]-n,h=t[2*o-1]-e,y=0;o>y;y++)r=s,i=h,s=t[2*y]-n,h=t[2*y+1]-e,i!=h&&(lup=h>i);for(var a=0,y=0;o>y;y++)if(r=s,i=h,s=t[2*y]-n,h=t[2*y+1]-e,!(0>i&&0>h||i>0&&h>0||0>r&&0>s)){if(i==h&&Math.min(r,s)<=0)return!0;if(i!=h){var l=r+(s-r)*-i/(h-i);if(0==l)return!0;l>0&&a++,0==i&&lup&&h>i&&a--,0==i&&!lup&&i>h&&a--,lup=h>i}}return 1==(1&a)},e.Slice=function(t,n,r,o,i){if(e.ContainsPoint(t,n,r)||e.ContainsPoint(t,o,i))return[t.slice(0)];for(var s=new e._P(n,r),h=new e._P(o,i),y=[],a=[],l=0;l<t.length;l+=2)a.push(new e._P(t[l],t[l+1]));for(var l=0;l<a.length;l++){var g=new e._P(0,0);g=e._GetLineIntersection(s,h,a[l],a[(l+1)%a.length],g),g&&(g.flag=!0,y.push(g),a.splice(l+1,0,g),l++)}if(0==y.length)return[t.slice(0)];var u=function(t,n){return e._P.dist(s,t)-e._P.dist(s,n)};y.sort(u);for(var p=[],f=0;y.length>0;){var x=(a.length,y[0]),c=y[1],v=a.indexOf(x),d=a.indexOf(c),_=!1;if(e._firstWithFlag(a,v)==d?_=!0:(x=y[1],c=y[0],v=a.indexOf(x),d=a.indexOf(c),e._firstWithFlag(a,v)==d&&(_=!0)),_){f--;var P=e._getPoints(a,v,d);p.push(P),a=e._getPoints(a,d,v),x.flag=c.flag=!1,y.splice(0,2),0==y.length&&p.push(a)}else f++,y.reverse();if(f>1)break}for(var L=[],l=0;l<p.length;l++){for(var m=p[l],M=[],k=0;k<m.length;k++)M.push(m[k].x,m[k].y);L.push(M)}return L},e.Raycast=function(t,n,r,o,i,s){var h=t.length-2,y=e._tp,a=y[0],l=y[1],g=y[2],u=y[3],p=y[4];a.x=n,a.y=r,l.x=n+o,l.y=r+i,null==s&&(s={dist:0,edge:0,norm:{x:0,y:0},refl:{x:0,y:0}}),s.dist=1/0;for(var f=0;h>f;f+=2){g.x=t[f],g.y=t[f+1],u.x=t[f+2],u.y=t[f+3];var x=e._RayLineIntersection(a,l,g,u,p);x&&e._updateISC(o,i,a,g,u,p,f/2,s)}g.x=u.x,g.y=u.y,u.x=t[0],u.y=t[1];var x=e._RayLineIntersection(a,l,g,u,p);return x&&e._updateISC(o,i,a,g,u,p,t.length/2,s),1/0!=s.dist?s:null},e.ClosestEdge=function(t,n,r,o){{var i=t.length-2,s=e._tp,h=s[0],y=s[2],a=s[3];s[4]}h.x=n,h.y=r,null==o&&(o={dist:0,edge:0,point:{x:0,y:0},norm:{x:0,y:0}}),o.dist=1/0;for(var l=0;i>l;l+=2)y.x=t[l],y.y=t[l+1],a.x=t[l+2],a.y=t[l+3],e._pointLineDist(h,y,a,l>>1,o);y.x=a.x,y.y=a.y,a.x=t[0],a.y=t[1],e._pointLineDist(h,y,a,i>>1,o);var g=1/o.dist;return o.norm.x=(n-o.point.x)*g,o.norm.y=(r-o.point.y)*g,o},e._pointLineDist=function(t,n,e,r,o){var i,s,h=t.x,y=t.y,a=n.x,l=n.y,g=e.x,u=e.y,p=h-a,f=y-l,x=g-a,c=u-l,v=p*x+f*c,d=x*x+c*c,_=v/d;0>_||a==g&&l==u?(i=a,s=l):_>1?(i=g,s=u):(i=a+_*x,s=l+_*c);var P=h-i,L=y-s,m=Math.sqrt(P*P+L*L);m<o.dist&&(o.dist=m,o.edge=r,o.point.x=i,o.point.y=s)},e._updateISC=function(t,n,r,o,i,s,h,y){var a=e._P.dist(r,s);if(a<y.dist){var l=1/e._P.dist(o,i),g=-(i.y-o.y)*l,u=(i.x-o.x)*l,p=2*(t*g+n*u);y.dist=a,y.norm.x=g,y.norm.y=u,y.refl.x=-p*g+t,y.refl.y=-p*u+n,y.edge=h}},e._getPoints=function(t,n,e){var r=t.length,o=[];n>e&&(e+=r);for(var i=n;e>=i;i++)o.push(t[i%r]);return o},e._firstWithFlag=function(t,n){for(var e=t.length;;)if(n=(n+1)%e,t[n].flag)return n},e._PointInTriangle=function(t,n,e,r,o,i,s,h){var y=s-e,a=h-r,l=o-e,g=i-r,u=t-e,p=n-r,f=y*y+a*a,x=y*l+a*g,c=y*u+a*p,v=l*l+g*g,d=l*u+g*p,_=1/(f*v-x*x),P=(v*c-x*d)*_,L=(f*d-x*c)*_;return P>=0&&L>=0&&1>P+L},e._RayLineIntersection=function(t,n,r,o,i){var s=t.x-n.x,h=r.x-o.x,y=t.y-n.y,a=r.y-o.y,l=s*a-y*h;if(0==l)return null;var g=t.x*n.y-t.y*n.x,u=r.x*o.y-r.y*o.x,p=i,f=1/l;return p.x=(g*h-s*u)*f,p.y=(g*a-y*u)*f,e._InRect(p,r,o)?y>0&&p.y>t.y||0>y&&p.y<t.y?null:s>0&&p.x>t.x||0>s&&p.x<t.x?null:p:null},e._GetLineIntersection=function(t,n,r,o,i){var s=t.x-n.x,h=r.x-o.x,y=t.y-n.y,a=r.y-o.y,l=s*a-y*h;if(0==l)return null;var g=t.x*n.y-t.y*n.x,u=r.x*o.y-r.y*o.x,p=i;return p.x=(g*h-s*u)/l,p.y=(g*a-y*u)/l,e._InRect(p,t,n)&&e._InRect(p,r,o)?p:null},e._InRect=function(t,n,e){return n.x==e.x?t.y>=Math.min(n.y,e.y)&&t.y<=Math.max(n.y,e.y):n.y==e.y?t.x>=Math.min(n.x,e.x)&&t.x<=Math.max(n.x,e.x):t.x>=Math.min(n.x,e.x)&&t.x<=Math.max(n.x,e.x)&&t.y>=Math.min(n.y,e.y)&&t.y<=Math.max(n.y,e.y)?!0:!1},e._convex=function(t,n,e,r,o,i){return(n-r)*(o-e)+(e-t)*(i-r)>=0},e._P=function(t,n){this.x=t,this.y=n,this.flag=!1},e._P.prototype.toString=function(){return"Point ["+this.x+", "+this.y+"]"},e._P.dist=function(t,n){var e=n.x-t.x,r=n.y-t.y;return Math.sqrt(e*e+r*r)},e._tp=[];for(var r=0;10>r;r++)e._tp.push(new e._P(0,0));n.Edge=function(t,e,r){var o=n.generateHash(t.x)+n.generateHash(t.y),i=n.generateHash(e.x)+n.generateHash(e.y),s=o+i;this.vertex1=t,this.vertex2=e,this.polygon1=r,this.polygon2=null,this.hash=s},n.Edge.prototype.getHash=function(){return this.hash},n.Edge.prototype.constructor=n.Edge,n.Mesh=function(){this.polygons=[],this.polygonLinks=[],this.graph=null},n.Mesh.prototype.getPolygons=function(){return this.polygons},n.Mesh.prototype.getPolygon=function(t){return this.polygons[t]},n.Mesh.prototype.addPolygon=function(t){this.polygons.push(t)},n.Mesh.prototype.prepareGraph=function(){this.edges=[],this.graph=[],this.polygonLinks=[];for(var t=0;t<this.polygons.length;t++)for(var e=this.polygons[t],r=e.getEdges(),o=0;o<r.length;o++){var i=r[o],s=i.getHash();void 0==this.polygonLinks[s]?this.polygonLinks[s]=[i]:this.polygonLinks[s].push(i)}var h,y=[];for(h in this.polygonLinks)if(this.polygonLinks[h].length>1){this.polygonLinks[h][0].polygon2=this.polygonLinks[h][1].polygon1,this.polygonLinks[h][1].polygon2=this.polygonLinks[h][0].polygon1;var a,l=n.generateHash(this.polygonLinks[h][0].polygon1.x)+n.generateHash(this.polygonLinks[h][0].polygon1.y);if(void 0!=y[l])a=y[l];else{var g=this.polygonLinks[h][0].polygon1.getCenter();a=new n.GraphNode(g.x,g.y),this.graph.push(a)}var u,p=n.generateHash(this.polygonLinks[h][1].polygon1.x)+n.generateHash(this.polygonLinks[h][1].polygon1.y);if(void 0!=y[p])u=y[p];else{var f=this.polygonLinks[h][1].polygon1.getCenter();u=new n.GraphNode(f.x,f.y),this.graph.push(u)}a.connectedGraphNodes.push(u),u.connectedGraphNodes.push(a)}},n.Mesh.prototype.constructor=n.Mesh,n.Polygon=function(t){this.setVertices(t)},n.Polygon.prototype.setVertices=function(t){this.vertices=[],this.edges=[];for(var e=0;e<t.length;e+=2){var r=new n.Vertex(t[e],t[e+1]);this.vertices.push(r)}for(var e=0;e<this.vertices.length;e++){var o;o=e<this.vertices.length-1?new n.Edge(this.vertices[e],this.vertices[e+1],this):new n.Edge(this.vertices[e],this.vertices[0],this),this.edges.push(o)}},n.Polygon.prototype.getVertices=function(){return this.vertices},n.Polygon.prototype.getVertex=function(t){return this.vertices[t]},n.Polygon.prototype.getEdges=function(){return this.edges},n.Polygon.prototype.setVertex=function(t,n){this.vertices[t]=n},n.Polygon.prototype.getCenter=function(){for(var t,e,r,o=0,i=0,s=0,h=0,y=this.vertices.length-1;h<this.vertices.length;y=h++)t=this.vertices[h],e=this.vertices[y],r=t.x*e.y-e.x*t.y,o+=r,i+=(t.x+e.x)*r,s+=(t.y+e.y)*r;return r=3*o,new n.Vertex(i/r,s/r)},n.Polygon.prototype.constructor=n.Polygon,n.Vertex=function(t,n){this.x=t,this.y=n},n.Vertex.prototype.constructor=n.Vertex,n.Graph=function(){},n.Graph.prototype.constructor=n.Graph,n.GraphNode=function(t,n){this.x=t,this.y=n,this.connectedGraphNodes=[]},n.GraphNode.prototype.constructor=n.GraphNode,n.verticesFromPolygon=function(t){for(var n=t.getVertices(),e=[],r=0;r<n.length;r++){var o=n[r];e.push(o.x,o.y)}return e},n.trianglesFromVertexArray=function(t){for(var e=[],r=0;r<t.length/6;r+=6){new n.Polygon([r,r+1,r+2,r+3,r+4,r+5])}return e},n.generateHash=function(t){return t=61^t^t>>16,t+=t<<3,t^=t>>4,t*=668265261,t^=t>>15},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=n),exports.TRAIL=n):"undefined"!=typeof define&&define.amd?define(n):t.TRAIL=n}).call(this);